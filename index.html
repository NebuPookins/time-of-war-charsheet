<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<style type="text/css">
			.roll-dice {
				cursor: pointer;
				font-size: 20px;
			}
		</style>
		<title>Battletech - A Time of War Character Sheet by Nebu Pookins</title>
	</head>
	<body>
		<div class="container">
			<form>
				<div class="form-group">
					<label for="pdfLink">PDF Rulebook URL (e.g. "file:///D:/A Time of War.pdf")</label>
					<input type="text" class="form-control" id="pdfLink" placeholder="file:///D:/A Time of War.pdf"/>
				</div>
			</form>
			<h1>Experience</h1>
			<form>
				<div class="row">
					<div class="col"><label for="xptotals-attributes">Attributes:</label></div>
					<div class="col"><input type="number" class="form-control" id="xptotals-attributes" value="0" readonly /></div>
					<div class="col">Traits:</div>
					<div class="col"><input type="number" class="form-control" id="xptotals-traits" value="0" readonly /></div>
					<div class="col">Skills:</div>
					<div class="col"><input type="number" class="form-control" id="xptotals-skills" value="0" readonly /></div>
					<div class="col">Total:</div>
					<div class="col"><input type="number" class="form-control" id="xptotals-totals" value="0" readonly /></div>
				</div>
			</form>
			<h1>Attributes</h1>
			<form>
				<table class="table table-sm" id="table-attributes">
					<thead>
						<tr>
							<th>Attribute</th><th>XP</th><th>Score</th><th>Link Bonus</th><th>Page Ref</th><th>Roll</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</form>
			<h1>Traits</h1>
			<form>
				<table class="table table-sm" id="table-traits">
					<thead>
						<tr>
							<th>Trait</th><th>Notes</th><th>XP</th><th>Trait Points</th><th>Page Ref</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" value="" id="hide-0-traits">
					<label class="form-check-label" for="hide-0-traits">Hide traits with XP = 0</label>
				</div>
			</form>
			<h1>Skills</h1>
			<form>
				<table class="table">
					<thead>
						<tr>
							<th>Skill</th><th>XP</th><th>Level</th><th>Link</th><th>TN</th><th>Probability</th><th>Page Ref</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td><label for="skill-acrobatics-freefall">Acrobatics/FreeFall</label></td>
							<td><input type="number" class="form-control" id="skill-acrobatics-freefall-xp" min="0" value="0"/></td>
							<td id="skill-acrobatics-freefall-level">1</td>
							<td>RFL</td>
							<td>8</td>
							<td>5%</td>
							<td><span class="pageRef" data-page="141">141</span>
						</tr>
					</tbody>
				</table>
			</form>
			<h1>Limitations/Known bugs</h1>
			<ul>
				<li>The "Alternate Identity" trait is currently not supported.</li>
				<li>A maximum of 2 compulsions is supported.</li>
			</ul>
		</div>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bacon.js/2.0.0/Bacon.min.js" integrity="sha256-ElhAkguPvgSASUOqfMpcCjzPCvAjbwbfNWIHVKODCPk=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" integrity="sha256-nRoO8HoupfqozUr7YKBRgHXmdx40Hl/04OSBzv7e7L8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.9.2/sweetalert2.all.min.js" integrity="sha256-qYRc9qsy2TRRLcRcGlTAdF2h+qKhqlhzoO3mYsW3lho=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.core.min.js" integrity="sha256-/WikzFcmjMZS+es0fni22evPN2lgZh8Dk2XXI/ZFtxM=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			////////////////////////////////////////////////////////////////////////
			// Generic Helpers
			////////////////////////////////////////////////////////////////////////
			function assert(test, message) {
				if (!test) {
					if (message) {
						throw message;
					} else {
						throw "AssertionFailed";
					}
				}
			}

			function toString(x) {
				if (typeof x.toString === 'function') {
					return x.toString();
				} else {
					return `${x}`;
				}
			}

			function assert_equal(actual, expected) {
				assert(_.isEqual(actual, expected), `Expected ${toString(expected)} but received ${toString(actual)}.`);
			}

			function identity(x) {
				return x;
			}

			/**
			 * Returns a function which, when invoked, will return each element in the
			 * provided array one at a time. Intended to be used to mock functions for
			 * testing.
			 */
			function mockFunction(...returnValues) {
				var position = 0;
				return function() {
					if (position >= returnValues.length) {
						throw `mockFunction invoked too many (${position + 1}) times`
					}
					position++;
					return returnValues[position - 1];
				};
			}

			/**
			 * Returns the largest index such that the element in the array at that
			 * index is smaller than or equal to the target. If the element at index 0 is larger
			 * than the target, returns -1.
			 *
			 * Assumes array is non-empty, sorted, unique values, etc.
			 */
			function binarySearch(target, array) {
				//left and right are indices, and inclusive range.
				function binarySearchRec(left, right) {
					if (left > right) {
						return left - 1;
					}
					if (left === right) {
						if (target < array[left]) {
							return left - 1;
						} else {
							return left;
						}
					}
					const mid = Math.ceil((left + right) / 2);
					if (target < array[mid]) {
						return binarySearchRec(left, mid - 1);
					} else {
						return binarySearchRec(mid, right);
					}
				}
				return binarySearchRec(0, array.length - 1);
			}
			(function() {
				//Tests for binarySearch
				assert_equal(binarySearch(0, [20]), -1);
				assert_equal(binarySearch(10, [20]), -1);
				assert_equal(binarySearch(20, [20]), 0);
				assert_equal(binarySearch(30, [20]), 0);
				assert_equal(binarySearch(0, [20, 30]), -1);
				assert_equal(binarySearch(10, [20, 30]), -1);
				assert_equal(binarySearch(20, [20, 30]), 0);
				assert_equal(binarySearch(25, [20, 30]), 0);
				assert_equal(binarySearch(30, [20, 30]), 1);
			})();

			function sumArray(array) {
				return array.reduce((accum, cur) => accum + cur, 0);
			}
			(function() {
				//Tests for sumArray
				assert_equal(sumArray([]), 0);
				assert_equal(sumArray([0]), 0);
				assert_equal(sumArray([5]), 5);
				assert_equal(sumArray([1, 2, 3]), 6);
			})();

			////////////////////////////////////////////////////////////////////////
			// Domain specific helpers
			////////////////////////////////////////////////////////////////////////
			const UNTRAINED = Symbol('untrained');
			const SKILL_SB = Symbol('Skill - Simple Basic');
			const ROLL_NORMAL = Symbol('Roll - Normal Result');
			const ROLL_FUMBLE = Symbol('Roll - Fumble Result');
			const ROLL_STUNNING = Symbol('Roll - Stunning Result');
			const ROLL_MIRACULOUS = Symbol('Roll - Miraculous Result');

			/**
			 * Returns the level of a skill, given how many XPs have been spent on the
			 * skill and whether the fast Learner or Slow learner trait has been
			 * acquired.
			 */
			function xpToSkillLevel(xp, fastSlowLearnerTP) {
				// Magic values taken from page 85
				const baseXpThresholdToSkillLevel = [20,30,50,80,120,170,230,300,380,470,570];
				var xpThresholdToSkillLevel;
				switch (fastSlowLearnerTP) {
					case -3:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel.map(x => x * 1.1);
						break;
					case 0:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel;
						break;
					case 3:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel.map(x => x * 0.9);
						break;
					default:
						debugger;
						throw `Got weird fastSlowLearnerTP ${fastSlowLearnerTP}`;
				}
				const skillLevel = binarySearch(xp, xpThresholdToSkillLevel);
				return skillLevel === -1 ? UNTRAINED : skillLevel;
			}
			(function() {
				//Tests for xpToSkillLevel
				assert_equal(xpToSkillLevel(0, -3), UNTRAINED);
				assert_equal(xpToSkillLevel(0, 0), UNTRAINED);
				assert_equal(xpToSkillLevel(0, 3), UNTRAINED);
				assert_equal(xpToSkillLevel(21, -3), UNTRAINED);
				assert_equal(xpToSkillLevel(19, 0), UNTRAINED);
				assert_equal(xpToSkillLevel(17, 3), UNTRAINED);
				assert_equal(xpToSkillLevel(22, -3), 0);
				assert_equal(xpToSkillLevel(20, 0), 0);
				assert_equal(xpToSkillLevel(18, 3), 0);
				assert_equal(xpToSkillLevel(23, -3), 0);
				assert_equal(xpToSkillLevel(21, 0), 0);
				assert_equal(xpToSkillLevel(19, 3), 0);
				assert_equal(xpToSkillLevel(32, -3), 0);
				assert_equal(xpToSkillLevel(29, 0), 0);
				assert_equal(xpToSkillLevel(26, 3), 0);
				assert_equal(xpToSkillLevel(33, -3), 1);
				assert_equal(xpToSkillLevel(30, 0), 1);
				assert_equal(xpToSkillLevel(27, 3), 1);
				assert_equal(xpToSkillLevel(34, -3), 1);
				assert_equal(xpToSkillLevel(31, 0), 1);
				assert_equal(xpToSkillLevel(28, 3), 1);
				//...
				assert_equal(xpToSkillLevel(626, -3), 9);
				assert_equal(xpToSkillLevel(569, 0), 9);
				assert_equal(xpToSkillLevel(512, 3), 9);
				assert_equal(xpToSkillLevel(627, -3), 10);
				assert_equal(xpToSkillLevel(570, 0), 10);
				assert_equal(xpToSkillLevel(513, 3), 10);
				assert_equal(xpToSkillLevel(1000000, -3), 10);
				assert_equal(xpToSkillLevel(1000000, 0), 10);
				assert_equal(xpToSkillLevel(1000000, 3), 10);
			})();

			function xpToAttributeLevel(xp) {
				return Math.max(0, Math.floor(xp / 100));
			}
			(function() {
				//Tests for xpToAttributeLevel
				assert_equal(xpToAttributeLevel(-1000), 0);
				assert_equal(xpToAttributeLevel(0), 0);
				assert_equal(xpToAttributeLevel(99), 0);
				assert_equal(xpToAttributeLevel(100), 1);
				assert_equal(xpToAttributeLevel(101), 1);
				assert_equal(xpToAttributeLevel(199), 1);
				assert_equal(xpToAttributeLevel(200), 2);
				assert_equal(xpToAttributeLevel(201), 2);
			})();

			function attributeScoreToLinkBonus(attrScore) {
				if (attrScore > 15) {
					return 5;
				}
				switch (attrScore) {
					case 0: return -4;
					case 1: return -2;
					case 2: return -1;
					case 3: return -1;
					case 4: return 0;
					case 5: return 0;
					case 6: return 0;
					case 7: return 1;
					case 8: return 1;
					case 9: return 1;
					case 10: return 2;
					case 11: return 3;
					case 12: return 4;
					case 13: return 4;
					case 14: return 4;
					case 15: return 5;
					default: throw `Got a weird attribute score: ${attrScore}`;
				}
			}

			function xpToTraitPoints(xp, allowedTps) {
				const tpIndex = binarySearch(xp / 100, allowedTps);
				return allowedTps[tpIndex];
			}
			(function() {
				//Tests for xpToAttributeLevel
				assert_equal(xpToTraitPoints(0, [0, 2]), 0);
				assert_equal(xpToTraitPoints(199, [0, 2]), 0);
				assert_equal(xpToTraitPoints(200, [0, 2]), 2);

				assert_equal(xpToTraitPoints(-300, [-3, 0, 3]), -3);
				assert_equal(xpToTraitPoints(-1, [-3, 0, 3]), -3);
				assert_equal(xpToTraitPoints(0, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(1, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(299, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(300, [-3, 0, 3]), 3);
			})();

			function rollD6() {
				return Math.floor(Math.random() * 6) + 1;
			}

			/**
			 * Normally rolls 2d6, but may roll up to 5d6 for miraculous results.
			 * 
			 * @return value looks like { type: ROLL_STUNNING, total: 15, individualDice: [6, 6, 3]}
			 */
			function rollActionCheck(injectedDie) {
				injectedDie = injectedDie || rollD6;
				const retVal = {
					individualDice: []
				};
				retVal.individualDice.push(injectedDie());
				retVal.individualDice.push(injectedDie());
				retVal.total = sumArray(retVal.individualDice);
				if (retVal.total === 2) {
					retVal.type = ROLL_FUMBLE;
					return retVal;
				}
				if (retVal.total < 12) {
					retVal.type = ROLL_NORMAL;
					return retVal;
				}
				while (retVal.individualDice.length < 5) {
					var bonusDie = injectedDie();
					retVal.total += bonusDie;
					retVal.individualDice.push(bonusDie);
					if (bonusDie != 6) {
						retVal.type = ROLL_STUNNING;
						return retVal;
					}
				}
				retVal.type = ROLL_MIRACULOUS;
				return retVal;
			}
			(function() {
				//Tests for rollActionCheck
				const fumbleScenarioResult = rollActionCheck(mockFunction(1, 1));
				assert_equal(fumbleScenarioResult.type, ROLL_FUMBLE);
				assert_equal(fumbleScenarioResult.total, 2);
				assert_equal(fumbleScenarioResult.individualDice, [1, 1]);

				const normalScenarioResult = rollActionCheck(mockFunction(3, 5));
				assert_equal(normalScenarioResult.type, ROLL_NORMAL);
				assert_equal(normalScenarioResult.total, 8);
				assert(normalScenarioResult.individualDice, [3, 5]);

				const stunningScenarioResult1 = rollActionCheck(mockFunction(6, 6, 3));
				assert_equal(stunningScenarioResult1.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult1.total, 15);
				assert(stunningScenarioResult1.individualDice, [6, 6, 3]);

				const stunningScenarioResult2 = rollActionCheck(mockFunction(6, 6, 6, 3));
				assert_equal(stunningScenarioResult2.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult2.total, 21);
				assert(stunningScenarioResult2.individualDice, [6, 6, 6, 3]);

				const stunningScenarioResult3 = rollActionCheck(mockFunction(6, 6, 6, 6, 3));
				assert_equal(stunningScenarioResult3.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult3.total, 27);
				assert(stunningScenarioResult3.individualDice, [6, 6, 6, 6, 3]);

				const miraculousResult = rollActionCheck(mockFunction(6, 6, 6, 6, 6));
				assert_equal(miraculousResult.type, ROLL_MIRACULOUS);
				assert_equal(miraculousResult.total, 30);
				assert(miraculousResult.individualDice, [6, 6, 6, 6, 6]);
			})();

			function diceToUnicode(value) {
				switch (value) {
					case 1: return 'âš€';
					case 2: return 'âš';
					case 3: return 'âš‚';
					case 4: return 'âšƒ';
					case 5: return 'âš„';
					case 6: return 'âš…';
				}
			}

			////////////////////////////////////////////////////////////////////////
			// DOM/Bacon plumbing
			////////////////////////////////////////////////////////////////////////
			$(function() {
				const urlParams = new URLSearchParams(window.location.search);
				var initialValueJson;
				if (urlParams.has('q')) {
					const dataString = urlParams.get('q');
					var decompressedString;
					
					if (dataString.startsWith('{')) {
						decompressedString = dataString;
					} else {
						decompressedString = LZString.decompressFromBase64(dataString);
					}
					initialValueJson = JSON.parse(decompressedString);
				} else {
					initialValueJson = {
						a: {
							str: 100,
							bod: 100,
							rfl: 100,
							dex: 100,
							int: 100,
							wil: 100,
							cha: 100,
							edg: 100
						},
						t: {}
					};
				}
				console.log('Initial value:', initialValueJson);

				function formElementToProperty($jqueryElement) {
					const changeEventValueStream = $jqueryElement
						.asEventStream('change')
						.map(event => event.target.value)
						.toProperty($jqueryElement.val());
					switch ($jqueryElement.attr('type')) {
						case 'number':
							return changeEventValueStream.map(Number);
						case 'checkbox':
						return changeEventValueStream.map((ignored) => $jqueryElement.is(':checked'));
						default:
							return changeEventValueStream;
					}
				}

				const $tableAttributes = $('#table-attributes');

				/**
				 * @param attrCode e.g 'STR'
				 */
				function createAttribute(attrCode, pageRef, initialValue) {
					const $tbody = $tableAttributes.find('tbody');
					const $tr = $('<tr>');
					const $tdLabel = $(`<td><label for="attribute-${attrCode}-xp">${attrCode.toUpperCase()}</label></td>`);
					const $inputXp = $(`<input type="number" class="form-control" id="attribute-${attrCode}-xp" min="100" value="${initialValue}" />`);
					const $tdXp = $('<td>');
					$tdXp.append($inputXp);
					const $tdScore = $('<td>1</td>');
					const $tdLinkbonus = $('<td>0</td>');
					const $tdPageref = $(`<td><span class="pageRef" data-page="${pageRef}">${pageRef}</span></td>`);
					const $tdRoll = $(`<td class="roll-dice">ðŸŽ²</td>`)
					$tr.append($tdLabel);
					$tr.append($tdXp);
					$tr.append($tdScore);
					$tr.append($tdLinkbonus);
					$tr.append($tdPageref);
					$tr.append($tdRoll);
					$tbody.append($tr);
					const attributeXpProperty = formElementToProperty($inputXp);
					const attributeScoreProperty = attributeXpProperty.map(xpToAttributeLevel);
					const attributeLinkbonusProperty = attributeScoreProperty.map(attributeScoreToLinkBonus);
					attributeScoreProperty.onValue(score => { $tdScore.text(score) });
					attributeLinkbonusProperty.onValue(bonus => { $tdLinkbonus.text(bonus) });

					attributeScoreProperty.sampledBy($tdRoll.asEventStream('click'))
						.onValue(attrScore => {
							const rollResults = rollActionCheck();
							const individualRollString = rollResults.individualDice.map(diceToUnicode).join('+');
							var exampleString;
							var modifiedTotal;
							var hitsTarget;
							switch (rollResults.type) {
								case ROLL_FUMBLE:
									exampleString = `You rolled ${individualRollString}, fumbling the attribute check.`;
									break;
								case ROLL_NORMAL:
									modifiedTotal = rollResults.total + attrScore;
									hitsTarget = modifiedTotal >= 12;
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}. Adding ${attrScore} yields ${modifiedTotal} which ${hitsTarget ? 'passes': 'fails'} the attribute check.`;
									break;
								case ROLL_STUNNING:
									modifiedTotal = rollResults.total + attrScore;
									hitsTarget = modifiedTotal >= 12;
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}, a stunning result! Adding ${attrScore} yields ${modifiedTotal} which ${hitsTarget ? 'passes': 'fails'} the attribute check.`;
									break;
								case ROLL_MIRACULOUS:
									exampleString = `You rolled ${individualRollString}, a miraculous result! You automatically succeed the attribute check, assuming it is physically possible to do so.`;
								default:
									throw `Unrecognized result type ${toStringrollResults.type}.`;
							}
							swal({
								titleText: `${attrCode.toUpperCase()} Attribute Check`,
								html: `<p>Roll 2d6 and add your ${attrCode.toUpperCase()} score (${attrScore}), trying to hit a target of 12.</p><p>Example: ${exampleString}`,
							});
							console.log('Clicked', attrCode);
						});
					return {
						xp: attributeXpProperty,
						score: attributeScoreProperty,
						link: attributeLinkbonusProperty,
					};
				}
				const attrProperties = {
					str: createAttribute('str', 34, initialValueJson.a.str),
					bod: createAttribute('bod', 34, initialValueJson.a.bod),
					rfl: createAttribute('rfl', 35, initialValueJson.a.rfl),
					dex: createAttribute('dex', 35, initialValueJson.a.dex),
					int: createAttribute('int', 35, initialValueJson.a.int),
					wil: createAttribute('wil', 35, initialValueJson.a.wil),
					cha: createAttribute('cha', 35, initialValueJson.a.cha),
					edg: createAttribute('edg', 35, initialValueJson.a.edg)
				};

				const $tableTraits = $('#table-traits');
				const hide0TraitsProperty = formElementToProperty($('#hide-0-traits'));
				function createTrait(name, id, allowedTps, pageRefs, initialValue) {
					initialValue = initialValue || {x: 0, n: ''};
					const minTp = Math.min(...allowedTps);
					const maxTp = Math.max(...allowedTps);
					const $tbody = $tableTraits.find('tbody');
					const $tr = $('<tr>');
					const $tdLabel = $(`<td><label for="trait-${id}">${name}</label></td>`);
					const $inputNotes = $(`<input type="text"/>`);
					$inputNotes.val(initialValue.n);
					const $tdNotes = $(`<td>`);
					$tdNotes.append($inputNotes);
					const $inputXp = $(`<input type="number" class="form-control" id="trait-${id}" min="${minTp * 100}" max="${maxTp * 100}" value="${initialValue.x}" />`);
					const $tdXp = $(`<td>`);
					$tdXp.append($inputXp);
					const $tdTp = $(`<td>0</td>`);
					const $tdPageref = $(`<td>`);
					$tdPageref.append(
						pageRefs.map((page) => `<span class="pageRef" data-page="${page}">${page}</span>`)
							.join(", ")
					);
					$tr.append($tdLabel);
					$tr.append($tdNotes);
					$tr.append($tdXp);
					$tr.append($tdTp);
					$tr.append($tdPageref);
					$tbody.append($tr);
					const traitXpProperty = formElementToProperty($inputXp);
					const traitNoteProperty = formElementToProperty($inputNotes);
					const traitTpProperty = traitXpProperty.map((xp) => xpToTraitPoints(xp, allowedTps));
					traitTpProperty.onValue(tp => $tdTp.text(tp));
					const shouldHideProperty = hide0TraitsProperty.combine(traitXpProperty, (hide, xp) => hide && xp == 0);
					shouldHideProperty.onValue(shouldHide => {
						if (shouldHide) {
							$tr.fadeOut()
						} else {
							$tr.fadeIn();
						}
					});
					return {
						xp: traitXpProperty,
						tp: traitTpProperty,
						notes: traitNoteProperty
					};
				}

				const traitProperties = {
					ambid: createTrait("Ambidextrous", 'ambidextrous', [0, 2], [108], initialValueJson.t.ambid),
					anima: createTrait("Animal Empathy, Animal Antipathy", 'animalempathy', [-1, 0, 1], [108], initialValueJson.t.anima),
					attra: createTrait("Attractive, Unattractive", 'attractive', [-2, 0, 2], [108, 128], initialValueJson.t.attra),
					blood: createTrait("Bloodmark", 'bloodmark', [-5, -4, -3, -2, -1, 0], [109], initialValueJson.t.blood),
					citiz: createTrait("Citizenship", 'citizenship', [0, 2], [109], initialValueJson.t.citiz),
					comba: createTrait("Combat Sense, Combat Paralysis", 'combatsense', [-4, 0, 4], [110], initialValueJson.t.comba),
					comp1: createTrait("Compulsion", 'compulsion1', [-5, -4, -3, -2, -1, 0], [110], initialValueJson.t.comp1),
					comp2: createTrait("Compulsion", 'compulsion2', [-5, -4, -3, -2, -1, 0], [110], initialValueJson.t.comp2),
					conn1: createTrait("Connections", 'connections1', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [112], initialValueJson.t.conn1),
					conn2: createTrait("Connections", 'connections2', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [112], initialValueJson.t.conn2),
					cust1: createTrait("Custom Vehicle", 'customVehicle1', [0, 1, 2, 3, 4, 5, 6], [112], initialValueJson.t.cust1),
					cust2: createTrait("Custom Vehicle", 'customVehicle2', [0, 1, 2, 3, 4, 5, 6], [112], initialValueJson.t.cust2),
					dark1: createTrait("Dark Secret", 'darkSecret1', [-5, -4, -3, -2, -1, 0], [112], initialValueJson.t.dark1),
					dark2: createTrait("Dark Secret", 'darkSecret2', [-5, -4, -3, -2, -1, 0], [112], initialValueJson.t.dark2),
					depe1: createTrait("Dependents", 'dependents1', [-2, -1, 0], [113], initialValueJson.t.depe1),
					depe2: createTrait("Dependents", 'dependents2', [-2, -1, 0], [113], initialValueJson.t.depe2),
					desi1: createTrait("Design Quirk", 'designQuirk1', [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5], [113], initialValueJson.t.desi1),
					desi2: createTrait("Design Quirk", 'designQuirk2', [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5], [113], initialValueJson.t.desi2),
					enem1: createTrait("Enemy", 'enemy1', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0], [113], initialValueJson.t.enem1),
					enem2: createTrait("Enemy", 'enemy2', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0], [113], initialValueJson.t.enem2),
					equip: createTrait("Equipped", 'equipped', [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8], [116], initialValueJson.t.equip),
					exStr: createTrait("Exceptional Attribute - Strength", 'exceptionalAttrStr', [0, 2], [116], initialValueJson.t.exStr),
					exBod: createTrait("Exceptional Attribute - Body", 'exceptionalAttrBod', [0, 2], [116], initialValueJson.t.exBod),
					exRfl: createTrait("Exceptional Attribute - Reflex", 'exceptionalAttrRfl', [0, 2], [116], initialValueJson.t.exRfl),
					exDex: createTrait("Exceptional Attribute - Dexterity", 'exceptionalAttrDex', [0, 2], [116], initialValueJson.t.exDex),
					exInt: createTrait("Exceptional Attribute - Intelligence", 'exceptionalAttrInt', [0, 2], [116], initialValueJson.t.exInt),
					exWil: createTrait("Exceptional Attribute - Willpower", 'exceptionalAttrWil', [0, 2], [116], initialValueJson.t.exWil),
					exCha: createTrait("Exceptional Attribute - Charisma", 'exceptionalAttrCha', [0, 2], [116], initialValueJson.t.exCha),
					exEdg: createTrait("Exceptional Attribute - Edge", 'exceptionalAttrEdg', [0, 2], [116], initialValueJson.t.exEdg),
					extra: createTrait("Extra Income", 'extraIncome', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [116], initialValueJson.t.extra),
					fastL: createTrait("Fast Learner, Slow Learner", 'fastlearner', [-3, 0, 3], [117, 125], initialValueJson.t.fastL),
					fit: createTrait("Fit, Handicap", 'fip', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 2], [117, 118], initialValueJson.t.fit),
					gtole: createTrait("G-Tolerance", 'gtolerance', [0, 1], [118], initialValueJson.t.gtole),
					heari: createTrait("Good Hearing, Poor Hearing", 'hearing', [-1, 0, 1], [118], initialValueJson.t.heari), //TODO: poor hearing pageref
					visio: createTrait("Good Vision, Poor Vision", 'vision', [-1, 0, 1], [118], initialValueJson.t.visio), //TODO: poor hearing pageref
					grega: createTrait("Gregarious, Introvert", 'gregarious', [-1, 0, 1], [118, 121], initialValueJson.t.grega),
					illit: createTrait("Illiterate", 'illiterate', [-1, 0], [119], initialValueJson.t.illit),
					impl1: createTrait("Implant/Prosthetic", 'implant1', [0, 1, 2, 3, 4, 5, 6], [119], initialValueJson.t.impl1),
					impl2: createTrait("Implant/Prosthetic", 'implant2', [0, 1, 2, 3, 4, 5, 6], [119], initialValueJson.t.impl2),
					inFo1: createTrait("In For Life", 'inForLife1', [-3, 0], [120], initialValueJson.t.inFo1),
					inFo2: createTrait("In For Life", 'inForLife2', [-3, 0], [120], initialValueJson.t.inFo2),
					lost1: createTrait("Lost Limb", 'lostLimb1', [-5, -4, -3, -2, -1, 0], [121], initialValueJson.t.lost1),
					lost2: createTrait("Lost Limb", 'lostLimb2', [-5, -4, -3, -2, -1, 0], [121], initialValueJson.t.lost2),
					natAc: createTrait("Natural Aptitude - Acrobatics", 'naturalAcrobatics', [0, 3], [121], initialValueJson.t.natAc),
					patie: createTrait("Patient, Impatient", 'patient', [-1, 0, 1], [119], initialValueJson.t.patie),
					techE: createTrait("Tech Empathy, Gremlins", 'techEmpathy', [-3, 0, 3], [118], initialValueJson.t.techE), //TODO: tech empathy pageref
					tough: createTrait("Toughness, Glassjaw", 'toughness', [-3, 0, 3], [118], initialValueJson.t.tough), //TODO: toughness pageref
					trueB: createTrait("Trueborn", 'trueborn', [0, 2], [109], initialValueJson.t.trueB),
				};

				const $skillAcrobaticsFreefallLevel = $('#skill-acrobatics-freefall-level');
				const skillAcrobaticsFreefallXpProperty = formElementToProperty($('#skill-acrobatics-freefall-xp'));
				const skillAcrobaticsFreefallLevelStream = skillAcrobaticsFreefallXpProperty
					.combine(traitProperties.fastL.tp, xpToSkillLevel);
				skillAcrobaticsFreefallLevelStream.onValue(lvl => {
					if (lvl === UNTRAINED) {
						$skillAcrobaticsFreefallLevel.text('Untrained');
					} else {
						$skillAcrobaticsFreefallLevel.text(lvl);
					}
				});

				const attributeXpProperty = Bacon.combineAsArray(
					Object.keys(attrProperties)
						.map(key => attrProperties[key])
						.map(attrObj => attrObj.xp)
				).map(sumArray);
				const $xptotalsAttributes = $('#xptotals-attributes');
				attributeXpProperty.onValue(xp => { $xptotalsAttributes.val(xp); });

				const traitXpProperty = Bacon.combineAsArray(
					Object.keys(traitProperties)
						.map(key => traitProperties[key])
						.map(traitObj => traitObj.xp)
				).map(sumArray);
				const $xptotalsTraits = $('#xptotals-traits');
				traitXpProperty.onValue(xp => { $xptotalsTraits.val(xp); });

				const baconCombineTemplate = {};
				baconCombineTemplate.a = {};
				Object.keys(attrProperties).forEach((k) => {
					baconCombineTemplate.a[k] = attrProperties[k].xp;
				});
				baconCombineTemplate.t = {};
				Object.keys(traitProperties).forEach((k) => {
					baconCombineTemplate.t[k] = {x: traitProperties[k].xp, n: traitProperties[k].notes}
				});
				const jsonDataProperty = Bacon.combineTemplate(baconCombineTemplate).map(json => {
					//Optimize/strip out traits, skills, etc. with 0 points.
					const retVal = {
						a: {},
						t: {}
					};
					Object.keys(json.a).forEach((k) => {
						retVal.a[k] = json.a[k];
					});
					Object.keys(json.t).forEach((k) => {
						if ((json.t[k].x != 0) || (json.t[k].n != ''))	 {
							retVal.t[k] = json.t[k];
						}
					});
					return retVal;
				});

				jsonDataProperty.onValue(v => {
					console.log('Exporting JSON:', v);
				});
				const compressedDataProperty = jsonDataProperty.map(v => {
					const uncompressedString = JSON.stringify(v);
					const compressedString = LZString.compressToBase64(uncompressedString);
					const uncompressedQuery = new URLSearchParams();
					uncompressedQuery.append('q', uncompressedString);
					const uncompressedQueryString = uncompressedQuery.toString();
					const compressedQuery = new URLSearchParams();
					compressedQuery.append('q', compressedString);
					const compressedQueryString = compressedQuery.toString();
					return uncompressedQueryString.length < compressedQueryString.length ? uncompressedQueryString : compressedQueryString;
				});
				compressedDataProperty.onValue(v => {
					const stateObj = '';
					const title = '';
					url = '?'+v;
					window.history.replaceState(stateObj, title, url);
				});
				const $pdfLink = $('#pdfLink');
				formElementToProperty($pdfLink)
					.onValue(url => {
						$('.pageRef').each(function(index, element) {
							const $element = $(element);
							const page = $element.data('page');
							if (url) {
								$element.html(`<a href="${url}#page=${page+2}" target="_blank">${page}</a>`);
							} else {
								$element.html(page);
							}
						});
					});
			});
		</script>
	</body>
</html>
