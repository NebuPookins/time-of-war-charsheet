<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<style type="text/css">
			.roll-dice {
				cursor: pointer;
				font-size: 20px;
			}
			.input-xp {
				width: 4em;
			}
		</style>
		<title>Battletech - A Time of War Character Sheet by Nebu Pookins</title>
	</head>
	<body>
		<div class="container">
			<form>
				<div class="form-group d-none d-lg-block">
					<label for="pdfLink">PDF Rulebook URL (e.g. "file:///D:/A Time of War.pdf")</label>
					<input type="text" class="form-control" id="pdfLink" placeholder="file:///D:/A Time of War.pdf"/>
				</div>
			</form>
			<h1>Experience</h1>
			<form class="form-inline">
				<div class="row">
					<div class="col">
						<label for="xptotals-attributes">Attributes:</label>
						<input type="number" class="form-control input-xp" id="xptotals-attributes" value="0" readonly />
					</div>
					<div class="col">
						<label for="xptotals-traits">Traits:</label>
						<input type="number" class="form-control input-xp" id="xptotals-traits" value="0" readonly />
					</div>
					<div class="col">
						<label for="xptotals-skills">Skills:</label>
						<input type="number" class="form-control input-xp" id="xptotals-skills" value="0" readonly />
					</div>
					<div class="col">
						<label for="xptotals-totals">Total:</label>
						<input type="number" class="form-control input-xp" id="xptotals-totals" value="0" readonly />
					</div>
				</div>
			</form>
			<h1>Attributes</h1>
			<form>
				<table class="table table-sm" id="table-attributes">
					<thead>
						<tr>
							<th>Roll</th><th>Attribute</th><th>XP</th><th>Score</th><th>Link Mod.</th><th class="d-none d-lg-block">Page Ref</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</form>
			<h1>Traits</h1>
			<form>
				<table class="table table-sm" id="table-traits">
					<thead>
						<tr>
							<th>Trait</th><th>Notes</th><th>XP</th><th>Trait Points</th><th class="d-none d-lg-block">Page Ref</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" value="" id="hide-0-traits">
					<label class="form-check-label" for="hide-0-traits">Hide traits with XP = 0</label>
				</div>
			</form>
			<h1>Skills</h1>
			<form>
				<table class="table table-sm" id="table-skills">
					<thead>
						<tr>
							<th>Roll</th><th>Skill</th><th>Notes</th><th>XP</th><th>Level</th><th>Link</th><th>TN/C</th><th class="d-none d-lg-block">Page Ref</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" value="" id="hide-0-skills">
					<label class="form-check-label" for="hide-0-skills">Hide skills with XP = 0</label>
				</div>
			</form>
			<h1>Limitations/Known bugs</h1>
			<ul>
				<li>The "Alternate Identity" trait is currently not supported.</li>
				<li>A maximum of 2 compulsions is supported.</li>
			</ul>
		</div>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bacon.js/2.0.0/Bacon.min.js" integrity="sha256-ElhAkguPvgSASUOqfMpcCjzPCvAjbwbfNWIHVKODCPk=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" integrity="sha256-nRoO8HoupfqozUr7YKBRgHXmdx40Hl/04OSBzv7e7L8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.9.2/sweetalert2.all.min.js" integrity="sha256-qYRc9qsy2TRRLcRcGlTAdF2h+qKhqlhzoO3mYsW3lho=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.core.min.js" integrity="sha256-/WikzFcmjMZS+es0fni22evPN2lgZh8Dk2XXI/ZFtxM=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			////////////////////////////////////////////////////////////////////////
			// Generic Helpers
			////////////////////////////////////////////////////////////////////////
			function assert(test, message) {
				if (!test) {
					if (message) {
						throw message;
					} else {
						throw "AssertionFailed";
					}
				}
			}

			function toString(x) {
				if (typeof x.toString === 'function') {
					return x.toString();
				} else {
					return `${x}`;
				}
			}

			function assert_equal(actual, expected) {
				assert(_.isEqual(actual, expected), `Expected ${toString(expected)} but received ${toString(actual)}.`);
			}

			function identity(x) {
				return x;
			}

			/**
			 * Returns a function which, when invoked, will return each element in the
			 * provided array one at a time. Intended to be used to mock functions for
			 * testing.
			 */
			function mockFunction(...returnValues) {
				var position = 0;
				return function() {
					if (position >= returnValues.length) {
						throw `mockFunction invoked too many (${position + 1}) times`
					}
					position++;
					return returnValues[position - 1];
				};
			}

			/**
			 * Returns the largest index such that the element in the array at that
			 * index is smaller than or equal to the target. If the element at index 0 is larger
			 * than the target, returns -1.
			 *
			 * Assumes array is non-empty, sorted, unique values, etc.
			 */
			function binarySearch(target, array) {
				//left and right are indices, and inclusive range.
				function binarySearchRec(left, right) {
					if (left > right) {
						return left - 1;
					}
					if (left === right) {
						if (target < array[left]) {
							return left - 1;
						} else {
							return left;
						}
					}
					const mid = Math.ceil((left + right) / 2);
					if (target < array[mid]) {
						return binarySearchRec(left, mid - 1);
					} else {
						return binarySearchRec(mid, right);
					}
				}
				return binarySearchRec(0, array.length - 1);
			}
			(function() {
				//Tests for binarySearch
				assert_equal(binarySearch(0, [20]), -1);
				assert_equal(binarySearch(10, [20]), -1);
				assert_equal(binarySearch(20, [20]), 0);
				assert_equal(binarySearch(30, [20]), 0);
				assert_equal(binarySearch(0, [20, 30]), -1);
				assert_equal(binarySearch(10, [20, 30]), -1);
				assert_equal(binarySearch(20, [20, 30]), 0);
				assert_equal(binarySearch(25, [20, 30]), 0);
				assert_equal(binarySearch(30, [20, 30]), 1);
			})();

			function sumArray(array) {
				return array.reduce((accum, cur) => accum + cur, 0);
			}
			(function() {
				//Tests for sumArray
				assert_equal(sumArray([]), 0);
				assert_equal(sumArray([0]), 0);
				assert_equal(sumArray([5]), 5);
				assert_equal(sumArray([1, 2, 3]), 6);
			})();

			////////////////////////////////////////////////////////////////////////
			// Domain specific helpers
			////////////////////////////////////////////////////////////////////////
			const UNTRAINED = Symbol('untrained');
			const SKILL_ACTION_SIMPLE = Symbol('Skill Action - Simple');
			const SKILL_ACTION_COMPLEX = Symbol('Skill Action - Complex');
			const SKILL_TRAINING_BASIC = Symbol('Skill Training - Basic');
			const SKILL_TRAINING_ADVANCED = Symbol('Skill Training - Advanced');
			const SKILL_TRAINING_TIERED = Symbol('Skill Training - Tiered');
			const ROLL_NORMAL = Symbol('Roll - Normal Result');
			const ROLL_FUMBLE = Symbol('Roll - Fumble Result');
			const ROLL_STUNNING = Symbol('Roll - Stunning Result');
			const ROLL_MIRACULOUS = Symbol('Roll - Miraculous Result');

			/**
			 * Returns the level of a skill, given how many XPs have been spent on the
			 * skill and whether the fast Learner or Slow learner trait has been
			 * acquired.
			 */
			function xpToSkillLevel(xp, fastSlowLearnerTP) {
				// Magic values taken from page 85
				const baseXpThresholdToSkillLevel = [20,30,50,80,120,170,230,300,380,470,570];
				var xpThresholdToSkillLevel;
				switch (fastSlowLearnerTP) {
					case -3:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel.map(x => x * 1.1);
						break;
					case 0:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel;
						break;
					case 3:
						xpThresholdToSkillLevel = baseXpThresholdToSkillLevel.map(x => x * 0.9);
						break;
					default:
						debugger;
						throw `Got weird fastSlowLearnerTP ${fastSlowLearnerTP}`;
				}
				const skillLevel = binarySearch(xp, xpThresholdToSkillLevel);
				return skillLevel === -1 ? UNTRAINED : skillLevel;
			}
			(function() {
				//Tests for xpToSkillLevel
				assert_equal(xpToSkillLevel(0, -3), UNTRAINED);
				assert_equal(xpToSkillLevel(0, 0), UNTRAINED);
				assert_equal(xpToSkillLevel(0, 3), UNTRAINED);
				assert_equal(xpToSkillLevel(21, -3), UNTRAINED);
				assert_equal(xpToSkillLevel(19, 0), UNTRAINED);
				assert_equal(xpToSkillLevel(17, 3), UNTRAINED);
				assert_equal(xpToSkillLevel(22, -3), 0);
				assert_equal(xpToSkillLevel(20, 0), 0);
				assert_equal(xpToSkillLevel(18, 3), 0);
				assert_equal(xpToSkillLevel(23, -3), 0);
				assert_equal(xpToSkillLevel(21, 0), 0);
				assert_equal(xpToSkillLevel(19, 3), 0);
				assert_equal(xpToSkillLevel(32, -3), 0);
				assert_equal(xpToSkillLevel(29, 0), 0);
				assert_equal(xpToSkillLevel(26, 3), 0);
				assert_equal(xpToSkillLevel(33, -3), 1);
				assert_equal(xpToSkillLevel(30, 0), 1);
				assert_equal(xpToSkillLevel(27, 3), 1);
				assert_equal(xpToSkillLevel(34, -3), 1);
				assert_equal(xpToSkillLevel(31, 0), 1);
				assert_equal(xpToSkillLevel(28, 3), 1);
				//...
				assert_equal(xpToSkillLevel(626, -3), 9);
				assert_equal(xpToSkillLevel(569, 0), 9);
				assert_equal(xpToSkillLevel(512, 3), 9);
				assert_equal(xpToSkillLevel(627, -3), 10);
				assert_equal(xpToSkillLevel(570, 0), 10);
				assert_equal(xpToSkillLevel(513, 3), 10);
				assert_equal(xpToSkillLevel(1000000, -3), 10);
				assert_equal(xpToSkillLevel(1000000, 0), 10);
				assert_equal(xpToSkillLevel(1000000, 3), 10);
			})();

			function xpToAttributeLevel(xp) {
				return Math.max(0, Math.floor(xp / 100));
			}
			(function() {
				//Tests for xpToAttributeLevel
				assert_equal(xpToAttributeLevel(-1000), 0);
				assert_equal(xpToAttributeLevel(0), 0);
				assert_equal(xpToAttributeLevel(99), 0);
				assert_equal(xpToAttributeLevel(100), 1);
				assert_equal(xpToAttributeLevel(101), 1);
				assert_equal(xpToAttributeLevel(199), 1);
				assert_equal(xpToAttributeLevel(200), 2);
				assert_equal(xpToAttributeLevel(201), 2);
			})();

			function attributeScoreToLinkBonus(attrScore) {
				if (attrScore > 15) {
					return 5;
				}
				switch (attrScore) {
					case 0: return -4;
					case 1: return -2;
					case 2: return -1;
					case 3: return -1;
					case 4: return 0;
					case 5: return 0;
					case 6: return 0;
					case 7: return 1;
					case 8: return 1;
					case 9: return 1;
					case 10: return 2;
					case 11: return 3;
					case 12: return 4;
					case 13: return 4;
					case 14: return 4;
					case 15: return 5;
					default: throw `Got a weird attribute score: ${attrScore}`;
				}
			}

			function xpToTraitPoints(xp, allowedTps) {
				const tpIndex = binarySearch(xp / 100, allowedTps);
				return allowedTps[tpIndex];
			}
			(function() {
				//Tests for xpToAttributeLevel
				assert_equal(xpToTraitPoints(0, [0, 2]), 0);
				assert_equal(xpToTraitPoints(199, [0, 2]), 0);
				assert_equal(xpToTraitPoints(200, [0, 2]), 2);

				assert_equal(xpToTraitPoints(-300, [-3, 0, 3]), -3);
				assert_equal(xpToTraitPoints(-1, [-3, 0, 3]), -3);
				assert_equal(xpToTraitPoints(0, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(1, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(299, [-3, 0, 3]), 0);
				assert_equal(xpToTraitPoints(300, [-3, 0, 3]), 3);
			})();

			function rollD6() {
				return Math.floor(Math.random() * 6) + 1;
			}

			/**
			 * Normally rolls 2d6, but may roll up to 5d6 for miraculous results.
			 * 
			 * @return value looks like { type: ROLL_STUNNING, total: 15, individualDice: [6, 6, 3]}
			 */
			function rollActionCheck(injectedDie) {
				injectedDie = injectedDie || rollD6;
				const retVal = {
					individualDice: []
				};
				retVal.individualDice.push(injectedDie());
				retVal.individualDice.push(injectedDie());
				retVal.total = sumArray(retVal.individualDice);
				if (retVal.total === 2) {
					retVal.type = ROLL_FUMBLE;
					return retVal;
				}
				if (retVal.total < 12) {
					retVal.type = ROLL_NORMAL;
					return retVal;
				}
				while (retVal.individualDice.length < 5) {
					var bonusDie = injectedDie();
					retVal.total += bonusDie;
					retVal.individualDice.push(bonusDie);
					if (bonusDie != 6) {
						retVal.type = ROLL_STUNNING;
						return retVal;
					}
				}
				retVal.type = ROLL_MIRACULOUS;
				return retVal;
			}
			(function() {
				//Tests for rollActionCheck
				const fumbleScenarioResult = rollActionCheck(mockFunction(1, 1));
				assert_equal(fumbleScenarioResult.type, ROLL_FUMBLE);
				assert_equal(fumbleScenarioResult.total, 2);
				assert_equal(fumbleScenarioResult.individualDice, [1, 1]);

				const normalScenarioResult = rollActionCheck(mockFunction(3, 5));
				assert_equal(normalScenarioResult.type, ROLL_NORMAL);
				assert_equal(normalScenarioResult.total, 8);
				assert(normalScenarioResult.individualDice, [3, 5]);

				const stunningScenarioResult1 = rollActionCheck(mockFunction(6, 6, 3));
				assert_equal(stunningScenarioResult1.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult1.total, 15);
				assert(stunningScenarioResult1.individualDice, [6, 6, 3]);

				const stunningScenarioResult2 = rollActionCheck(mockFunction(6, 6, 6, 3));
				assert_equal(stunningScenarioResult2.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult2.total, 21);
				assert(stunningScenarioResult2.individualDice, [6, 6, 6, 3]);

				const stunningScenarioResult3 = rollActionCheck(mockFunction(6, 6, 6, 6, 3));
				assert_equal(stunningScenarioResult3.type, ROLL_STUNNING);
				assert_equal(stunningScenarioResult3.total, 27);
				assert(stunningScenarioResult3.individualDice, [6, 6, 6, 6, 3]);

				const miraculousResult = rollActionCheck(mockFunction(6, 6, 6, 6, 6));
				assert_equal(miraculousResult.type, ROLL_MIRACULOUS);
				assert_equal(miraculousResult.total, 30);
				assert(miraculousResult.individualDice, [6, 6, 6, 6, 6]);
			})();

			function diceToUnicode(value) {
				switch (value) {
					case 1: return '⚀';
					case 2: return '⚁';
					case 3: return '⚂';
					case 4: return '⚃';
					case 5: return '⚄';
					case 6: return '⚅';
				}
			}

			////////////////////////////////////////////////////////////////////////
			// DOM/Bacon plumbing
			////////////////////////////////////////////////////////////////////////
			$(function() {
				const urlParams = new URLSearchParams(window.location.search);
				var initialValueJson;
				if (urlParams.has('q')) {
					const dataString = urlParams.get('q');
					var decompressedString;
					
					if (dataString.startsWith('{')) {
						decompressedString = dataString;
					} else {
						decompressedString = LZString.decompressFromBase64(dataString);
					}
					initialValueJson = JSON.parse(decompressedString);
				} else {
					initialValueJson = {
						a: {
							str: 100,
							bod: 100,
							rfl: 100,
							dex: 100,
							int: 100,
							wil: 100,
							cha: 100,
							edg: 100
						},
						t: {},
						s: {}
					};
				}
				console.log('Initial value:', initialValueJson);

				function formElementToProperty($jqueryElement) {
					const changeEventValueStream = $jqueryElement
						.asEventStream('change')
						.map(event => event.target.value)
						.toProperty($jqueryElement.val());
					switch ($jqueryElement.attr('type')) {
						case 'number':
							return changeEventValueStream.map(Number);
						case 'checkbox':
						return changeEventValueStream.map((ignored) => $jqueryElement.is(':checked'));
						default:
							return changeEventValueStream;
					}
				}

				const $tableAttributes = $('#table-attributes');

				/**
				 * @param attrCode e.g 'STR'
				 */
				function createAttribute(attrCode, pageRef, initialValue) {
					const $tbody = $tableAttributes.find('tbody');
					const $tr = $('<tr>');
					const $tdRoll = $(`<td class="roll-dice">🎲</td>`)
					const $tdLabel = $(`<td><label for="attribute-${attrCode}-xp">${attrCode.toUpperCase()}</label></td>`);
					const $inputXp = $(`<input type="number" class="form-control input-xp" id="attribute-${attrCode}-xp" min="100" value="${initialValue}" />`);
					const $tdXp = $('<td>');
					$tdXp.append($inputXp);
					const $tdScore = $('<td>1</td>');
					const $tdLinkbonus = $('<td>0</td>');
					const $tdPageref = $(`<td class="d-none d-lg-block"><span class="pageRef" data-page="${pageRef}">${pageRef}</span></td>`);
					$tr.append($tdRoll);
					$tr.append($tdLabel);
					$tr.append($tdXp);
					$tr.append($tdScore);
					$tr.append($tdLinkbonus);
					$tr.append($tdPageref);
					$tbody.append($tr);
					const attributeXpProperty = formElementToProperty($inputXp);
					const attributeScoreProperty = attributeXpProperty.map(xpToAttributeLevel);
					const attributeLinkbonusProperty = attributeScoreProperty.map(attributeScoreToLinkBonus);
					attributeScoreProperty.onValue(score => { $tdScore.text(score) });
					attributeLinkbonusProperty.onValue(bonus => { $tdLinkbonus.text(bonus) });

					attributeScoreProperty.sampledBy($tdRoll.asEventStream('click'))
						.onValue(attrScore => {
							const rollResults = rollActionCheck();
							const individualRollString = rollResults.individualDice.map(diceToUnicode).join('+');
							var exampleString;
							var modifiedTotal;
							var hitsTarget;
							switch (rollResults.type) {
								case ROLL_FUMBLE:
									exampleString = `You rolled ${individualRollString}, fumbling the attribute check.`;
									break;
								case ROLL_NORMAL:
									modifiedTotal = rollResults.total + attrScore;
									hitsTarget = modifiedTotal >= 12;
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}. Adding ${attrScore} yields ${modifiedTotal} which ${hitsTarget ? 'passes': 'fails'} the attribute check.`;
									break;
								case ROLL_STUNNING:
									modifiedTotal = rollResults.total + attrScore;
									hitsTarget = modifiedTotal >= 12;
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}, a stunning result! Adding ${attrScore} yields ${modifiedTotal} which ${hitsTarget ? 'passes': 'fails'} the attribute check.`;
									break;
								case ROLL_MIRACULOUS:
									exampleString = `You rolled ${individualRollString}, a miraculous result! You automatically succeed the attribute check, assuming it is physically possible to do so.`;
								default:
									throw `Unrecognized result type ${toStringrollResults.type}.`;
							}
							swal({
								titleText: `${attrCode.toUpperCase()} Attribute Check`,
								html: `<p>Roll 2d6 and add your ${attrCode.toUpperCase()} score (${attrScore}), trying to hit a target of 12.</p><p>Example: ${exampleString}`,
							});
						});
					return {
						xp: attributeXpProperty,
						score: attributeScoreProperty,
						link: attributeLinkbonusProperty,
					};
				}
				const attrProperties = {
					str: createAttribute('str', 34, initialValueJson.a.str),
					bod: createAttribute('bod', 34, initialValueJson.a.bod),
					rfl: createAttribute('rfl', 35, initialValueJson.a.rfl),
					dex: createAttribute('dex', 35, initialValueJson.a.dex),
					int: createAttribute('int', 35, initialValueJson.a.int),
					wil: createAttribute('wil', 35, initialValueJson.a.wil),
					cha: createAttribute('cha', 35, initialValueJson.a.cha),
					edg: createAttribute('edg', 35, initialValueJson.a.edg)
				};

				const $tableTraits = $('#table-traits');
				const hide0TraitsProperty = formElementToProperty($('#hide-0-traits'));
				function createTrait(name, id, allowedTps, pageRefs, initialValue) {
					initialValue = initialValue || {x: 0, n: ''};
					const minTp = Math.min(...allowedTps);
					const maxTp = Math.max(...allowedTps);
					const $tbody = $tableTraits.find('tbody');
					const $tr = $('<tr>');
					const $tdLabel = $(`<td><label for="trait-${id}">${name}</label></td>`);
					const $inputNotes = $(`<input type="text" class="form-control" type="text"/>`);
					$inputNotes.val(initialValue.n);
					const $tdNotes = $(`<td>`);
					$tdNotes.append($inputNotes);
					const $inputXp = $(`<input type="number" class="form-control input-xp" id="trait-${id}" min="${minTp * 100}" max="${maxTp * 100}" value="${initialValue.x}" />`);
					const $tdXp = $(`<td>`);
					$tdXp.append($inputXp);
					const $tdTp = $(`<td>0</td>`);
					const $tdPageref = $(`<td class="d-none d-lg-block">`);
					$tdPageref.append(
						pageRefs.map((page) => `<span class="pageRef" data-page="${page}">${page}</span>`)
							.join(", ")
					);
					$tr.append($tdLabel);
					$tr.append($tdNotes);
					$tr.append($tdXp);
					$tr.append($tdTp);
					$tr.append($tdPageref);
					$tbody.append($tr);
					const traitXpProperty = formElementToProperty($inputXp);
					const traitNoteProperty = formElementToProperty($inputNotes);
					const traitTpProperty = traitXpProperty.map((xp) => xpToTraitPoints(xp, allowedTps));
					traitTpProperty.onValue(tp => $tdTp.text(tp));
					const shouldHideProperty = hide0TraitsProperty.combine(traitXpProperty, (hide, xp) => hide && xp == 0);
					shouldHideProperty.onValue(shouldHide => {
						if (shouldHide) {
							$tr.fadeOut()
						} else {
							$tr.fadeIn();
						}
					});
					return {
						xp: traitXpProperty,
						tp: traitTpProperty,
						notes: traitNoteProperty
					};
				}

				const traitProperties = {
					ambid: createTrait("Ambidextrous", 'ambidextrous', [0, 2], [108], initialValueJson.t.ambid),
					anima: createTrait("Animal Empathy, Animal Antipathy", 'animalempathy', [-1, 0, 1], [108], initialValueJson.t.anima),
					attra: createTrait("Attractive, Unattractive", 'attractive', [-2, 0, 2], [108, 128], initialValueJson.t.attra),
					blood: createTrait("Bloodmark", 'bloodmark', [-5, -4, -3, -2, -1, 0], [109], initialValueJson.t.blood),
					citiz: createTrait("Citizenship", 'citizenship', [0, 2], [109], initialValueJson.t.citiz),
					comba: createTrait("Combat Sense, Combat Paralysis", 'combatsense', [-4, 0, 4], [110], initialValueJson.t.comba),
					comp1: createTrait("Compulsion", 'compulsion1', [-5, -4, -3, -2, -1, 0], [110], initialValueJson.t.comp1),
					comp2: createTrait("Compulsion", 'compulsion2', [-5, -4, -3, -2, -1, 0], [110], initialValueJson.t.comp2),
					conn1: createTrait("Connections", 'connections1', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [112], initialValueJson.t.conn1),
					conn2: createTrait("Connections", 'connections2', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [112], initialValueJson.t.conn2),
					cust1: createTrait("Custom Vehicle", 'customVehicle1', [0, 1, 2, 3, 4, 5, 6], [112], initialValueJson.t.cust1),
					cust2: createTrait("Custom Vehicle", 'customVehicle2', [0, 1, 2, 3, 4, 5, 6], [112], initialValueJson.t.cust2),
					dark1: createTrait("Dark Secret", 'darkSecret1', [-5, -4, -3, -2, -1, 0], [112], initialValueJson.t.dark1),
					dark2: createTrait("Dark Secret", 'darkSecret2', [-5, -4, -3, -2, -1, 0], [112], initialValueJson.t.dark2),
					depe1: createTrait("Dependents", 'dependents1', [-2, -1, 0], [113], initialValueJson.t.depe1),
					depe2: createTrait("Dependents", 'dependents2', [-2, -1, 0], [113], initialValueJson.t.depe2),
					desi1: createTrait("Design Quirk", 'designQuirk1', [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5], [113], initialValueJson.t.desi1),
					desi2: createTrait("Design Quirk", 'designQuirk2', [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5], [113], initialValueJson.t.desi2),
					enem1: createTrait("Enemy", 'enemy1', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0], [113], initialValueJson.t.enem1),
					enem2: createTrait("Enemy", 'enemy2', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0], [113], initialValueJson.t.enem2),
					equip: createTrait("Equipped", 'equipped', [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8], [116], initialValueJson.t.equip),
					exStr: createTrait("Exceptional Attribute - Strength", 'exceptionalAttrStr', [0, 2], [116], initialValueJson.t.exStr),
					exBod: createTrait("Exceptional Attribute - Body", 'exceptionalAttrBod', [0, 2], [116], initialValueJson.t.exBod),
					exRfl: createTrait("Exceptional Attribute - Reflex", 'exceptionalAttrRfl', [0, 2], [116], initialValueJson.t.exRfl),
					exDex: createTrait("Exceptional Attribute - Dexterity", 'exceptionalAttrDex', [0, 2], [116], initialValueJson.t.exDex),
					exInt: createTrait("Exceptional Attribute - Intelligence", 'exceptionalAttrInt', [0, 2], [116], initialValueJson.t.exInt),
					exWil: createTrait("Exceptional Attribute - Willpower", 'exceptionalAttrWil', [0, 2], [116], initialValueJson.t.exWil),
					exCha: createTrait("Exceptional Attribute - Charisma", 'exceptionalAttrCha', [0, 2], [116], initialValueJson.t.exCha),
					exEdg: createTrait("Exceptional Attribute - Edge", 'exceptionalAttrEdg', [0, 2], [116], initialValueJson.t.exEdg),
					extra: createTrait("Extra Income", 'extraIncome', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [116], initialValueJson.t.extra),
					fastL: createTrait("Fast Learner, Slow Learner", 'fastlearner', [-3, 0, 3], [117, 125], initialValueJson.t.fastL),
					fit: createTrait("Fit, Handicap", 'fip', [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 2], [117, 118], initialValueJson.t.fit),
					gtole: createTrait("G-Tolerance", 'gtolerance', [0, 1], [118], initialValueJson.t.gtole),
					heari: createTrait("Good Hearing, Poor Hearing", 'hearing', [-1, 0, 1], [118], initialValueJson.t.heari), //TODO: poor hearing pageref
					visio: createTrait("Good Vision, Poor Vision", 'vision', [-1, 0, 1], [118], initialValueJson.t.visio), //TODO: poor hearing pageref
					grega: createTrait("Gregarious, Introvert", 'gregarious', [-1, 0, 1], [118, 121], initialValueJson.t.grega),
					illit: createTrait("Illiterate", 'illiterate', [-1, 0], [119], initialValueJson.t.illit),
					impl1: createTrait("Implant/Prosthetic", 'implant1', [0, 1, 2, 3, 4, 5, 6], [119], initialValueJson.t.impl1),
					impl2: createTrait("Implant/Prosthetic", 'implant2', [0, 1, 2, 3, 4, 5, 6], [119], initialValueJson.t.impl2),
					inFo1: createTrait("In For Life", 'inForLife1', [-3, 0], [120], initialValueJson.t.inFo1),
					inFo2: createTrait("In For Life", 'inForLife2', [-3, 0], [120], initialValueJson.t.inFo2),
					lost1: createTrait("Lost Limb", 'lostLimb1', [-5, -4, -3, -2, -1, 0], [121], initialValueJson.t.lost1),
					lost2: createTrait("Lost Limb", 'lostLimb2', [-5, -4, -3, -2, -1, 0], [121], initialValueJson.t.lost2),
					natAcroba: createTrait("Natural Aptitude - Acrobatics", 'naturalAcrobatics', [0, 3], [121], initialValueJson.t.natAcroba),
					natActing: createTrait("Natural Aptitude - Acting", 'naturalActing', [0, 3], [121], initialValueJson.t.natActing),
					//TODO add the other natural aptitudes here
					natComput: createTrait("Natural Aptitude - Computers", 'naturalComputers', [0, 3], [121], initialValueJson.t.natComput),
					natPiloti: createTrait("Natural Aptitude - Piloting", 'naturalPiloting', [0, 3], [121], initialValueJson.t.natPiloti),
					patie: createTrait("Patient, Impatient", 'patient', [-1, 0, 1], [119], initialValueJson.t.patie),
					techE: createTrait("Tech Empathy, Gremlins", 'techEmpathy', [-3, 0, 3], [118], initialValueJson.t.techE), //TODO: tech empathy pageref
					tough: createTrait("Toughness, Glassjaw", 'toughness', [-3, 0, 3], [118], initialValueJson.t.tough), //TODO: toughness pageref
					trueB: createTrait("Trueborn", 'trueborn', [0, 2], [109], initialValueJson.t.trueB),
				};

				const $tableSkills = $('#table-skills');
				const hide0SkillsProperty = formElementToProperty($('#hide-0-skills'));
				/**
				 * @param names array of String of length 1 or 2. name[0] is the skill
				 * 		name, name[1] is the subskill if any. If the array has length 2,
				 * 		and name[1] is null, this is a special value indicating that the
				 * 		subskill should be specified by the notes.
				 * @param id used to construct HTML id.
				 * @param linkedAttrs array that looks like ['str'], ['str', 'rfl'] or
				 * 		['str', ['str', 'rfl']] for basic, advanced and tiered skills
				 * 		respectively.
				 */
				function createSkill(names, id, linkedAttrs, actionRating, pageRefs, initialValue) {
					const skillTraining =
						linkedAttrs.length === 1 ? SKILL_TRAINING_BASIC :
						_.isArray(linkedAttrs[1]) ? SKILL_TRAINING_TIERED :
						SKILL_TRAINING_ADVANCED;
					initialValue = initialValue || {x: 0, n: ''};

					const $tbody = $tableSkills.find('tbody');
					const $tr = $('<tr>');
					const $tdRoll = $(`<td class="roll-dice">🎲</td>`)
					const $label = $(`<label for="skill-${id}"></label>`);
					const $tdLabel = $(`<td>`);
					$tdLabel.append($label);
					const $inputNotes = $(`<input type="text" class="form-control" value="${initialValue.n}"/>`);
					const $tdNotes = $(`<td>`);
					$tdNotes.append($inputNotes);
					const $inputXp = $(`<input type="number" class="form-control input-xp" id="skill-${id}-xp" min="0" value="${initialValue.x}"/>`);
					const $tdXp = $('<td>');
					const $tdLevel = $('<td>');
					const $tdLink = $('<td>');
					const $tdTarget = $('<td>');
					const $tdPageRef = $('<td class="d-none d-lg-block">');
					$tdPageRef.append(
						pageRefs.map((page) => `<span class="pageRef" data-page="${page}">${page}</span>`)
							.join(", ")
					);
					$tdXp.append($inputXp);
					$tr.append($tdRoll);
					$tr.append($tdLabel);
					$tr.append($tdNotes);
					$tr.append($tdXp);
					$tr.append($tdLevel);
					$tr.append($tdLink);
					$tr.append($tdTarget);
					$tr.append($tdPageRef);
					$tbody.append($tr);
					const skillXpProperty = formElementToProperty($inputXp);
					const skillNoteProperty = formElementToProperty($inputNotes);
					const displayNameProperty = skillNoteProperty.map(notes => {
						if (names.length == 1) {
							return names[0];
						} else {
							if (names[1] === null) {
								if (notes === '') {
									return `${names[0]}/Specify in Notes`;
								} else {
									return `${names[0]}/${notes}`;
								}
							} else {
								return `${names[0]}/${names[1]}`;
							}
						}
					});
					displayNameProperty.onValue(displayName => { $label.text(displayName); });
					const skillLevelProperty = skillXpProperty
						.combine(traitProperties.fastL.tp, xpToSkillLevel);
					const skillBelow4Property = skillLevelProperty.map(lvl => lvl === UNTRAINED || lvl < 4);
					const skillLinkProperty = skillBelow4Property.map(below4 => {
						switch(skillTraining) {
							case SKILL_TRAINING_BASIC:
								return [linkedAttrs[0]];
							case SKILL_TRAINING_ADVANCED:
								return [linkedAttrs[0], linkedAttrs[1]];
							case SKILL_TRAINING_TIERED:
								return below4 ? [linkedAttrs[0]] : [linkedAttrs[1][0], linkedAttrs[1][1]];
							default:
								throw `Unknown skill training type ${toString(skillTraining)}`;
						}
					});
					const skillEffectiveTrainingProperty = skillBelow4Property.map(below4 => {
						switch(skillTraining) {
							case SKILL_TRAINING_BASIC:
								return SKILL_TRAINING_BASIC;
							case SKILL_TRAINING_ADVANCED:
								return SKILL_TRAINING_ADVANCED;
							case SKILL_TRAINING_TIERED:
								return below4 ? SKILL_TRAINING_BASIC : SKILL_TRAINING_ADVANCED;
							default:
								throw `Unknown skill training type ${toString(skillTraining)}`;
						}
					});
					const skillTNProperty = skillEffectiveTrainingProperty.map(effectiveTraining => {
						//These magic numbers come from page 40.
						switch(effectiveTraining) {
							case SKILL_TRAINING_BASIC:
								return actionRating === SKILL_ACTION_SIMPLE ? 7 : 8;
							case SKILL_TRAINING_ADVANCED:
								return actionRating === SKILL_ACTION_SIMPLE ? 8 : 9;
							default:
								throw `Unknown skill training type ${toString(skillTraining)}`;
						}
					});
					skillLevelProperty.onValue(lvl => {
						if (lvl === UNTRAINED) {
							$tdLevel.text('Untrained');
						} else {
							$tdLevel.text(lvl);
						}
					});
					skillLinkProperty.onValue(arrLinkAttr => { $tdLink.text(arrLinkAttr.map(attr => attr.toUpperCase()).join('+')); });
					Bacon.combineTemplate({
						tn: skillTNProperty,
						effectiveTraining: skillEffectiveTrainingProperty
					}).onValue(obj => {
						$tdTarget.text(`${obj.tn}/${actionRating == SKILL_ACTION_SIMPLE ? 'S':'C'}${obj.effectiveTraining == SKILL_TRAINING_BASIC ? 'B': 'A' }`)
					});
					Bacon.combineTemplate({
						lvl: skillLevelProperty,
						linkedAttrs: skillLinkProperty,
						attrs: attrProperties,
						effectiveTraining: skillEffectiveTrainingProperty,
						tn: skillTNProperty,
						displayName: displayNameProperty
					}).sampledBy($tdRoll.asEventStream('click'))
						.onValue(obj => {
							//TODO handle Natural Aptitude
							const rollResults = rollActionCheck();
							const individualRollString = rollResults.individualDice.map(diceToUnicode).join('+');
							var exampleString;
							
							switch (rollResults.type) {
								case ROLL_FUMBLE:
									exampleString = `You rolled ${individualRollString}, fumbling the attribute check.`;
									break;
								case ROLL_NORMAL:
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}.`;
									break;
								case ROLL_STUNNING:
									exampleString = `You rolled ${individualRollString} = ${rollResults.total}, a stunning result!`;
									break;
								case ROLL_MIRACULOUS:
									exampleString = `You rolled ${individualRollString}, a miraculous result! You automatically succeed the attribute check, assuming it is physically possible to do so.`;
								default:
									throw `Unrecognized result type ${toStringrollResults.type}.`;
							}
							var explanation;
							var attrModifiers;
							var modifiedTotal;
							var hitsTarget;
							if (obj.lvl === UNTRAINED) {
								if (obj.linkedAttrs.length == 1) {
									explanation = `<p>You're untrained in ${obj.displayName}, so roll 2D6 and add your ${obj.linkedAttrs[0].toUpperCase()} score (${obj.attrs[obj.linkedAttrs[0]].score}), plus any conditional modifiers the gamemaster deems fit, trying to hit a target of 12.</p>`;
									if (rollResults.type == ROLL_FUMBLE || rollResults == ROLL_MIRACULOUS) {
										explanation += `<p>Example: ${exampleString}</p>`
									} else {
										modifiedTotal = rollResults.total + obj.attrs[obj.linkedAttrs[0]].score;
										hitsTarget = modifiedTotal >= 12;
										explanation += `<p>Example: ${exampleString} Adding ${obj.attrs[obj.linkedAttrs[0]].score} yields ${modifiedTotal} which ${hitsTarget ? 'passes':'fails'} the skill check.</p>`
									}
								} else {
									attrModifiers = obj.attrs[obj.linkedAttrs[0]].score + obj.attrs[obj.linkedAttrs[1]].score;
									explanation = `<p>You're untrained in ${obj.displayName}, so roll 2D6 and add your ${obj.linkedAttrs[0].toUpperCase()} and ${obj.linkedAttrs[1].toUpperCase()} scores (${obj.attrs[obj.linkedAttrs[0]].score} + ${obj.attrs[obj.linkedAttrs[1]].score} = ${attrModifiers}), plus any conditional modifiers the gamemaster deems fit, trying to hit a target of 18.</p>`;
									if (rollResults.type == ROLL_FUMBLE || rollResults == ROLL_MIRACULOUS) {
										explanation += `<p>Example: ${exampleString}</p>`
									} else {
										modifiedTotal = rollResults.total + attrModifiers;
										hitsTarget = modifiedTotal >= 18;
										explanation += `<p>Example: ${exampleString} Adding ${attrModifiers} yields ${modifiedTotal} which ${hitsTarget ? 'passes':'fails'} the skill check.</p>`
									}
								}
							} else {
								var linkedAttrExplanation;
								if (obj.linkedAttrs.length == 1) {
									linkedAttrExplanation = `${obj.linkedAttrs[0].toUpperCase()} attribute (${obj.attrs[obj.linkedAttrs[0]].link})`;
									attrModifiers = obj.attrs[obj.linkedAttrs[0]].link;
								} else {
									attrModifiers = obj.attrs[obj.linkedAttrs[0]].link + obj.attrs[obj.linkedAttrs[1]].link;
									linkedAttrExplanation = `${obj.linkedAttrs[0].toUpperCase()} and ${obj.linkedAttrs[1].toUpperCase()} attributes (${obj.attrs[obj.linkedAttrs[0]].link}+${obj.attrs[obj.linkedAttrs[1]].link}=${attrModifiers})`;
								}
								explanation = `<p>You are trained in ${obj.displayName}, so roll 2D6 adding your skill level (${obj.lvl}) and the linked attribute modifier for the ${linkedAttrExplanation}, and any conditional modifiers the game master deems fit. Because this skill is rated as ${actionRating === SKILL_ACTION_SIMPLE ? 'Simple' : 'Complex'}-${obj.effectiveTraining === SKILL_TRAINING_BASIC ? 'Basic':'Advanced'}, you're trying to hit a target score of ${obj.tn}.</p>`;
								if (rollResults.type == ROLL_FUMBLE || rollResults == ROLL_MIRACULOUS) {
									explanation += `<p>Example: ${exampleString}</p>`
								} else {
									modifiedTotal = rollResults.total + obj.lvl + attrModifiers;
									hitsTarget = modifiedTotal >= obj.tn;
									explanation += `<p>Example: ${exampleString} Adding ${obj.lvl} and ${attrModifiers} yields ${modifiedTotal} which ${hitsTarget ? 'passes':'fails'} the skill check.</p>`
								}
							}
							swal({
								titleText: `${obj.displayName} Skill Check`,
								html: explanation,
							});
						});
					const shouldHideProperty = hide0SkillsProperty.combine(skillXpProperty, (hide, xp) => hide && xp == 0);
					shouldHideProperty.onValue(shouldHide => {
						if (shouldHide) {
							$tr.fadeOut()
						} else {
							$tr.fadeIn();
						}
					});
					return {
						xp: skillXpProperty,
						notes: skillNoteProperty
					}
				}

				const skillProperties = {};

				(function() {
					function createSkillHelper(shortName, longNames, linkedAttrs, actionRating, pageRef) {
						skillProperties[shortName] = createSkill(
							longNames,
							shortName,
							linkedAttrs,
							actionRating == 's' ? SKILL_ACTION_SIMPLE : SKILL_ACTION_COMPLEX,
							[pageRef],
							initialValueJson.s[shortName]);
					}
					createSkillHelper('acroba-fre', ["Acrobatics", "Freefall"],                 ['rfl'],                 's', 142);
					createSkillHelper('acroba-gym', ["Acrobatics", "Gymnastics"],               ['rfl'],                 's', 142);
					createSkillHelper('acting',     ["Acting"],                                 ['cha'],                 'c', 142);
					createSkillHelper('admini',     ["Administration"],                         ['int', 'wil'],          's', 143);
					createSkillHelper('animal-her', ["Animal Handling", "Herding"],             ['wil'],                 's', 143);
					createSkillHelper('animal-rid', ["Animal Handling", "Riding"],              ['wil'],                 's', 143);
					createSkillHelper('animal-tra', ["Animal Handling", "Training"],            ['wil'],                 's', 143);
					createSkillHelper('apprai',     ["Appraisal"],                              ['int'],                 'c', 143);
					createSkillHelper('archer',     ["Archery"],                                ['dex'],                 's', 143);
					createSkillHelper('art-000',    ["Art", null],                              ['dex', ['dex', 'int']], 'c', 144);
					createSkillHelper('art-001',    ["Art", null],                              ['dex', ['dex', 'int']], 'c', 144);
					createSkillHelper('art-002',    ["Art", null],                              ['dex', ['dex', 'int']], 'c', 144);
					createSkillHelper('art-003',    ["Art", null],                              ['dex', ['dex', 'int']], 'c', 144);
					createSkillHelper('art-004',    ["Art", null],                              ['dex', ['dex', 'int']], 'c', 144);
					createSkillHelper('artill',     ["Artillery"],                              ['int', 'wil'],          's', 144);
					createSkillHelper('career-000', ["Career", null],                           ['int'],                 's', 144);
					createSkillHelper('career-001', ["Career", null],                           ['int'],                 's', 144);
					createSkillHelper('career-002', ["Career", null],                           ['int'],                 's', 144);
					createSkillHelper('career-003', ["Career", null],                           ['int'],                 's', 144);
					createSkillHelper('career-004', ["Career", null],                           ['int'],                 's', 144);
					createSkillHelper('climbi',     ["Climbing"],                               ['dex'],                 's', 144);
					createSkillHelper('commun-bla', ["Communications", "Black Box"],            ['int'],                 's', 144);
					createSkillHelper('commun-con', ["Communications", "Conventional"],         ['int'],                 's', 144);
					createSkillHelper('commun-hyp', ["Communications", "Hyperpulse Generator"], ['int'],                 's', 144);
					createSkillHelper('comput',     ["Computers"],                              ['int', ['dex', 'int']], 'c', 145);
					createSkillHelper('crypto',     ["Cryptography"],                           ['int', 'wil'],          'c', 145);
					createSkillHelper('demoli',     ["Demolitions"],                            ['dex', 'int'],          'c', 146);
					createSkillHelper('disgui',     ["Disguise"],                               ['cha'],                 's', 146);
					createSkillHelper('drivin-gro', ["Driving", "Ground Vehicles"],             ['rfl', 'dex'],          's', 146);
					createSkillHelper('drivin-rai', ["Driving", "Rail Vehicles"],               ['rfl', 'dex'],          's', 146);
					createSkillHelper('drivin-sea', ["Driving", "Sea Vehicles"],                ['rfl', 'dex'],          's', 146);
					createSkillHelper('escape',     ["Escape Artist"],                          ['str', 'dex'],          'c', 147);
					createSkillHelper('forger',     ["Forgery"],                                ['dex', 'int'],          's', 147);
					createSkillHelper('gunner-aer', ["Gunnery", "Aerospace"],                   ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-air', ["Gunnery", "Air Vehicle"],                 ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-bat', ["Gunnery", "Battlesuit"],                  ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-gro', ["Gunnery", "Ground Vehicle"],              ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-mec', ["Gunnery", "'Mech"],                       ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-pro', ["Gunnery", "ProtoMech"],                   ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-sea', ["Gunnery", "Sea Vehicle"],                 ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-spa', ["Gunnery", "Spacecraft"],                  ['rfl', 'dex'],          's', 147);
					createSkillHelper('gunner-tur', ["Gunnery", "Turret"],                      ['rfl', 'dex'],          's', 147);
					createSkillHelper('intere-000', ["Interest", null],                         ['int', ['int', 'wil']], 'c', 147);
					createSkillHelper('intere-001', ["Interest", null],                         ['int', ['int', 'wil']], 'c', 147);
					createSkillHelper('intere-002', ["Interest", null],                         ['int', ['int', 'wil']], 'c', 147);
					createSkillHelper('intere-003', ["Interest", null],                         ['int', ['int', 'wil']], 'c', 147);
					createSkillHelper('intere-004', ["Interest", null],                         ['int', ['int', 'wil']], 'c', 147);
					createSkillHelper('interr',     ["Interrogation"],                          ['wil', 'cha'],          'c', 148);
					createSkillHelper('invest',     ["Investigation"],                          ['int', 'wil'],          'c', 148);
					createSkillHelper('langua-000', ["Language", null],                         ['int', 'cha'],          's', 148);
					createSkillHelper('langua-001', ["Language", null],                         ['int', 'cha'],          's', 148);
					createSkillHelper('langua-002', ["Language", null],                         ['int', 'cha'],          's', 148);
					createSkillHelper('langua-003', ["Language", null],                         ['int', 'cha'],          's', 148);
					createSkillHelper('langua-004', ["Language", null],                         ['int', 'cha'],          's', 148);
					createSkillHelper('leader',     ["Leadership"],                             ['wil', 'cha'],          's', 148);
					createSkillHelper('martia',     ["Martial Arts"],                           ['rfl', ['rfl', 'dex']], 's', 149);
					createSkillHelper('medtec-gen', ["MedTech", "General"],                     ['int'],                 's', 149);
					createSkillHelper('medtec-vet', ["MedTech", "Veterinary"],                  ['int'],                 's', 149);
					createSkillHelper('meleew',     ["Melee Weapons"],                          ['dex', ['rfl', 'dex']], 's', 149);
					createSkillHelper('naviga-air', ["Navigation", "Air"],                      ['int'],                 's', 150);
					createSkillHelper('naviga-gro', ["Navigation", "Ground"],                   ['int'],                 's', 150);
					createSkillHelper('naviga-kfj', ["Navigation", "K-F Jump"],                 ['int'],                 's', 150);
					createSkillHelper('naviga-sea', ["Navigation", "Sea"],                      ['int'],                 's', 150);
					createSkillHelper('naviga-spa', ["Navigation", "Space"],                    ['int'],                 's', 150);
					createSkillHelper('negoti',     ["Negotiation"],                            ['cha'],                 'c', 150);
					createSkillHelper('percep',     ["Perception"],                             ['int'],                 's', 151);
					createSkillHelper('piloti-aer', ["Piloting", "Aerospace"],                  ['rfl', 'dex'],          's', 151);
					createSkillHelper('piloti-air', ["Piloting", "Air Vehicle"],                ['rfl', 'dex'],          's', 151);
					createSkillHelper('piloti-bat', ["Piloting", "Battlesuit"],                 ['rfl', 'dex'],          's', 151);
					createSkillHelper('piloti-mec', ["Piloting", "'Mech"],                      ['rfl', 'dex'],          's', 151);
					createSkillHelper('piloti-pro', ["Piloting", "ProtoMech"],                  ['rfl', 'dex'],          's', 151);
					createSkillHelper('piloti-spa', ["Piloting", "Spacecraft"],                 ['rfl', 'dex'],          's', 151);
					createSkillHelper('presti-pic', ["Prestidigitation", "Pick Pocket"],        ['dex', ['rfl', 'dex']], 's', 152);
					createSkillHelper('presti-qui', ["Prestidigitation", "Quickdraw"],          ['dex', ['rfl', 'dex']], 's', 152);
					createSkillHelper('presti-sle', ["Prestidigitation", "Sleight of Hand"],    ['dex', ['rfl', 'dex']], 's', 152);
					createSkillHelper('protoc-000', ["Protocol", null],                         ['wil', 'cha'],          'c', 152);
					createSkillHelper('protoc-001', ["Protocol", null],                         ['wil', 'cha'],          'c', 152);
					createSkillHelper('protoc-002', ["Protocol", null],                         ['wil', 'cha'],          'c', 152);
					createSkillHelper('protoc-003', ["Protocol", null],                         ['wil', 'cha'],          'c', 152);
					createSkillHelper('protoc-004', ["Protocol", null],                         ['wil', 'cha'],          'c', 152);
					createSkillHelper('runnin',     ["Running"],                                ['rfl'],                 's', 153);
					createSkillHelper('scienc-000', ["Science", null],                          ['int', 'wil'],          'c', 153);
					createSkillHelper('scienc-001', ["Science", null],                          ['int', 'wil'],          'c', 153);
					createSkillHelper('scienc-002', ["Science", null],                          ['int', 'wil'],          'c', 153);
					createSkillHelper('scienc-003', ["Science", null],                          ['int', 'wil'],          'c', 153);
					createSkillHelper('scienc-004', ["Science", null],                          ['int', 'wil'],          'c', 153);
					createSkillHelper('sensor',     ["Sensor Operations"],                      ['int', 'wil'],          's', 153);
					createSkillHelper('smalla',     ["Small Arms"],                             ['dex'],                 's', 153);
					createSkillHelper('stealt',     ["Stealth"],                                ['rfl', 'int'],          's', 154);
					createSkillHelper('strate',     ["Strategy"],                               ['int', 'wil'],          'c', 154);
					createSkillHelper('street-fed', ["Streetwise", "Federated Suns"],           ['cha'],                 'c', 154);
					createSkillHelper('street-out', ["Streetwise", "Outworlds Alliance"],       ['cha'],                 'c', 154);
					createSkillHelper('suppor',     ["Support Weapons"],                        ['dex'],                 's', 154);
					createSkillHelper('surger-gen', ["Surgery", "General"],                     ['dex', 'int'],          'c', 155);
					createSkillHelper('surger-vet', ["Surgery", "Veterinary"],                  ['dex', 'int'],          'c', 155);
					createSkillHelper('surviv-000', ["Survival", null],                         ['bod', 'int'],          'c', 156);
					createSkillHelper('surviv-001', ["Survival", null],                         ['bod', 'int'],          'c', 156);
					createSkillHelper('surviv-002', ["Survival", null],                         ['bod', 'int'],          'c', 156);
					createSkillHelper('surviv-003', ["Survival", null],                         ['bod', 'int'],          'c', 156);
					createSkillHelper('surviv-004', ["Survival", null],                         ['bod', 'int'],          'c', 156);
					createSkillHelper('swimmi',     ["Swimming"],                               ['str'],                 's', 156);
					createSkillHelper('tactic-air', ["Tactics", "Air"],                         ['int', 'wil'],          'c', 156);
					createSkillHelper('tactic-inf', ["Tactics", "Infantry"],                    ['int', 'wil'],          'c', 156);
					createSkillHelper('tactic-lan', ["Tactics", "Land"],                        ['int', 'wil'],          'c', 156);
					createSkillHelper('tactic-sea', ["Tactics", "Sea"],                         ['int', 'wil'],          'c', 156);
					createSkillHelper('tactic-spa', ["Tactics", "Space"],                       ['int', 'wil'],          'c', 156);
					createSkillHelper('techni-aer', ["Technician", "Aeronautics"],              ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-cyb', ["Technician", "Cybernetics"],              ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-ele', ["Technician", "Electronic"],               ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-jet', ["Technician", "Jets"],                     ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-mec', ["Technician", "Mechanical"],               ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-myo', ["Technician", "Myomer"],                   ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-nuc', ["Technician", "Nuclear"],                  ['dex', 'int'],          'c', 157);
					createSkillHelper('techni-wea', ["Technician", "Weapons"],                  ['dex', 'int'],          'c', 157);
					createSkillHelper('thrown-bla', ["Thrown Weapons", "Blades"],               ['dex'],                 's', 158);
					createSkillHelper('thrown-blu', ["Thrown Weapons", "Blunt Weapons"],        ['dex'],                 's', 158);
					createSkillHelper('tracki-urb', ["Tracking", "Urban"],                      ['int', 'wil'],          's', 158);
					createSkillHelper('tracki-wil', ["Tracking", "Wilds"],                      ['int', 'wil'],          's', 158);
					createSkillHelper('traini',     ["Training"],                               ['int', 'cha'],          'c', 159);
					createSkillHelper('zerogo',     ["Zero-G Operations"],                      ['rfl'],                 's', 159);
				})();

				const attributeXpProperty = Bacon.combineAsArray(
					Object.keys(attrProperties)
						.map(key => attrProperties[key])
						.map(attrObj => attrObj.xp)
				).map(sumArray);
				const $xptotalsAttributes = $('#xptotals-attributes');
				attributeXpProperty.onValue(xp => { $xptotalsAttributes.val(xp); });

				const traitXpProperty = Bacon.combineAsArray(
					Object.keys(traitProperties)
						.map(key => traitProperties[key])
						.map(traitObj => traitObj.xp)
				).map(sumArray);
				const $xptotalsTraits = $('#xptotals-traits');
				traitXpProperty.onValue(xp => { $xptotalsTraits.val(xp); });

				const skillXpProperty = Bacon.combineAsArray(
					Object.keys(skillProperties)
						.map(key => skillProperties[key])
						.map(skillObj => skillObj.xp)
				).map(sumArray);
				const $xptotalsSkills = $('#xptotals-skills');
				skillXpProperty.onValue(xp => { $xptotalsSkills.val(xp); });

				const $xptotalsGrandTotal = $('#xptotals-totals');
				Bacon.combineWith(attributeXpProperty, traitXpProperty, skillXpProperty, (a, t, s) => a+t+s)
					.onValue(xp => { $xptotalsGrandTotal.val(xp); });

				const baconCombineTemplate = {
					a: {},
					t: {},
					s: {}
				};
				Object.keys(attrProperties).forEach((k) => {
					baconCombineTemplate.a[k] = attrProperties[k].xp;
				});
				Object.keys(traitProperties).forEach((k) => {
					baconCombineTemplate.t[k] = {
						x: traitProperties[k].xp,
						n: traitProperties[k].notes
					};
				});
				Object.keys(skillProperties).forEach((k) => {
					baconCombineTemplate.s[k] = {
						x: skillProperties[k].xp,
						n: skillProperties[k].notes
					};
				});

				const jsonDataProperty = Bacon.combineTemplate(baconCombineTemplate).map(json => {
					//Optimize/strip out traits, skills, etc. with 0 points.
					const retVal = {
						a: {},
						t: {},
						s: {},
					};
					Object.keys(json.a).forEach((k) => {
						retVal.a[k] = json.a[k];
					});
					Object.keys(json.t).forEach((k) => {
						if ((json.t[k].x != 0) || (json.t[k].n != '')) {
							retVal.t[k] = json.t[k];
						}
					});
					Object.keys(json.s).forEach((k) => {
						if ((json.s[k].x != 0) || (json.s[k].n != '')) {
							retVal.s[k] = json.s[k];
						}
					});
					return retVal;
				});

				jsonDataProperty.onValue(v => {
					console.log('Exporting JSON:', v);
				});
				const compressedDataProperty = jsonDataProperty.map(v => {
					const uncompressedString = JSON.stringify(v);
					const compressedString = LZString.compressToBase64(uncompressedString);
					const uncompressedQuery = new URLSearchParams();
					uncompressedQuery.append('q', uncompressedString);
					const uncompressedQueryString = uncompressedQuery.toString();
					const compressedQuery = new URLSearchParams();
					compressedQuery.append('q', compressedString);
					const compressedQueryString = compressedQuery.toString();
					return uncompressedQueryString.length < compressedQueryString.length ? uncompressedQueryString : compressedQueryString;
				});
				compressedDataProperty.onValue(v => {
					const stateObj = '';
					const title = '';
					url = '?'+v;
					window.history.replaceState(stateObj, title, url);
				});
				const $pdfLink = $('#pdfLink');
				formElementToProperty($pdfLink)
					.onValue(url => {
						$('.pageRef').each(function(index, element) {
							const $element = $(element);
							const page = $element.data('page');
							if (url) {
								$element.html(`<a href="${url}#page=${page+2}" target="_blank">${page}</a>`);
							} else {
								$element.html(page);
							}
						});
					});
			});
		</script>
	</body>
</html>
